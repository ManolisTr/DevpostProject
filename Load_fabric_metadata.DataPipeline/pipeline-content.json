{
  "properties": {
    "activities": [
      {
        "name": "Load FABRIC_METADATA",
        "type": "Script",
        "dependsOn": [],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 0,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "linkedService": {
          "name": "DW_DEV",
          "objectId": "5d8bbdb3-60f1-4115-b697-bb21134b8787",
          "properties": {
            "annotations": [],
            "type": "DataWarehouse",
            "typeProperties": {
              "endpoint": "fgm6cdfxlexujcq5ohbjdqfdce-udckoy2gpyyudnpobmz5nhss5m.datawarehouse.fabric.microsoft.com",
              "artifactId": "5d8bbdb3-60f1-4115-b697-bb21134b8787",
              "workspaceId": "63a7c4a0-7e46-4131-b5ee-0b33d69e52eb"
            }
          }
        },
        "typeProperties": {
          "scripts": [
            {
              "type": "Query",
              "text": {
                "value": "WITH ALL_TABLES AS (\nselect distinct \n          t.TABLE_CATALOG           \t\t\t\t\t\t AS LH_NAME\n        , lower(t.TABLE_SCHEMA) \t\t\t\t\t\t\t as SOURCE_SCHEMA\n        , lower(t.TABLE_NAME) \t\t\t\t\t\t\t\t as SOURCE_TABLE\n        , lower(t.TABLE_SCHEMA) + '_' + lower(t.TABLE_NAME)  AS DESTINATION_TABLE\n        , t.TABLE_TYPE  \t\t\t\t\t\t\t\t\t AS TABLE_TYPE\n      from [DEV_Lakehouse].[dbo].[information_schema_tables] as t \n    inner\n      join [DEV_Lakehouse].[dbo].[information_schema_columns] as c \n        on t.TABLE_SCHEMA  = c.TABLE_SCHEMA \n      and t.TABLE_NAME    = c.TABLE_NAME \n      and t.TABLE_CATALOG = 'AdventureWorks'\n      and t.TABLE_TYPE    = 'BASE TABLE'\n)\n, pk AS (\n         SELECT ku.TABLE_CATALOG\n              , ku.TABLE_SCHEMA\n              , ku.TABLE_NAME\n              , ku.COLUMN_NAME\n           FROM [DEV_Lakehouse].[dbo].[information_schema_table_constraints] AS tc\n          INNER \n           JOIN [DEV_Lakehouse].[dbo].[information_schema_key_column_usage] AS ku\n             ON tc.CONSTRAINT_TYPE = 'PRIMARY KEY'\n            AND tc.CONSTRAINT_NAME = ku.CONSTRAINT_NAME\n        )\n, all_pks as (\n SELECT c.TABLE_SCHEMA\n       , c.TABLE_NAME\n       , c.COLUMN_NAME\n       , c.DATA_TYPE\n       , c.COLUMN_DEFAULT\n       , c.CHARACTER_MAXIMUM_LENGTH\n       , c.NUMERIC_PRECISION\n       , c.IS_NULLABLE       \n       , CASE \n            WHEN pk.COLUMN_NAME IS NOT NULL \n              THEN 'PRIMARY KEY' \n            ELSE '' \n         END                 AS KeyType\n    FROM [DEV_Lakehouse].[dbo].[information_schema_columns] c \n    inner \n    JOIN   pk \n      ON  c.TABLE_CATALOG = pk.TABLE_CATALOG\n     AND c.TABLE_SCHEMA = pk.TABLE_SCHEMA\n     AND c.TABLE_NAME = pk.TABLE_NAME\n     AND c.COLUMN_NAME = pk.COLUMN_NAME \n)\n, CONCATENATED_PK AS (\nselect TABLE_SCHEMA\n   , TABLE_NAME\n   , STRING_AGG(COLUMN_NAME, ',') AS PRIMARY_KEY\n  from all_pks \n  group by TABLE_SCHEMA, TABLE_NAME \n  )\nINSERT INTO [DW_DEV].[CTRL].[FABRIC_METADATA]\n(\n      SOURCE_SYSTEM,\n      LH_NAME ,\n      SOURCE_SCHEMA ,\n      SOURCE_TABLE ,\n      DESTINATION_TABLE ,\n      TABLE_TYPE ,\n      PRIMARY_KEY,\n      LOADING_METHOD,  \n      ACTIVE,\n      FREQUENCY ,\n      VERSION\n)\nSELECT  'Adventure Works', \n\t\tALL_TABLES.LH_NAME,\n\t\tALL_TABLES.SOURCE_SCHEMA,\n\t\tALL_TABLES.SOURCE_TABLE,\n\t\tALL_TABLES.DESTINATION_TABLE,\n\t\tALL_TABLES.TABLE_TYPE,\n\t\tCONCATENATED_PK.PRIMARY_KEY,\n    'Full' as LOADING_METHOD,\n     1 as ACTIVE,\n     '1D' AS FREQUENCY,\n     SYSDATETIME()\n  FROM ALL_TABLES \n  INNER \n  JOIN CONCATENATED_PK \n   ON upper(trim(ALL_TABLES.SOURCE_SCHEMA)) = upper(trim(CONCATENATED_PK.TABLE_SCHEMA))\n   AND upper(trim(ALL_TABLES.SOURCE_TABLE)) = upper(trim(CONCATENATED_PK.TABLE_NAME))\n  LEFT\n  JOIN CTRL.FABRIC_METADATA AS CURRENT_TABLES\n    ON ALL_TABLES.LH_NAME = CURRENT_TABLES.LH_NAME\n   AND ALL_TABLES.DESTINATION_TABLE = CURRENT_TABLES.DESTINATION_TABLE\n WHERE  CURRENT_TABLES.DESTINATION_TABLE IS NULL;",
                "type": "Expression"
              }
            }
          ],
          "scriptBlockExecutionTimeout": "02:00:00"
        }
      }
    ]
  }
}